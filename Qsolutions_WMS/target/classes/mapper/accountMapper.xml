<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="co.kr.qsolutions.mapper.accountMapper">

 	
 	<!-- Login처리 -->
    
 	<!-- 특정유저 검색 -->
    <select id="UserCheckID" resultType="UserVO" parameterType="String">
    	select 
    		userid, userpasswd, username
    	from 
    		user
    	<where>
    		userid = #{userid}
    	</where>    
    </select>
    <select id="UserViewSelect" resultType="UserVO" parameterType="String">
    	select
    		userid, username, usermobile,useremail,usercompanycode,u.deptcode,d.deptname,u.positioncode,p.positionname,c.companyname
    	from 
    		user u left join dept d ON u.deptcode = d.deptcode
            left join positions p ON u.positioncode = p.positioncode 
            left join company c ON u.usercompanycode = c.companycode
    	<where>
    		userid = #{userid}
    	</where>    
    </select>
 	<!-- 전체 유저 검색 -->
    <select id="SelectUserList" resultType="UserVO" parameterType="PagingVO">
    	select
    		userid, username, usermobile,useremail,usercompanycode,u.deptcode,d.deptname,u.positioncode,p.positionname,c.companyname
    	from 
    		user u left join dept d ON u.deptcode = d.deptcode
            left join positions p ON u.positioncode = p.positioncode 
            left join company c ON u.usercompanycode = c.companycode
    	<trim prefix="WHERE" prefixOverrides="AND |OR ">
	       	<if test="searchType=='userid'">
	       		userid like CONCAT('%',#{searchData},'%')
	       	</if>
	       	<if test="searchType=='username'">
	       		username like CONCAT('%',#{searchData},'%')
	       	</if>
			AND u.IsUse = 0
		</trim>
		ORDER BY
			usercompanycode desc
		Limit #{start},#{last}
    </select>
    
    <select id="SelectUserCount" resultType="Integer" parameterType="PagingVO">
    	select
    		count(*)
    	from
    		user
    	<trim prefix="WHERE" prefixOverrides="AND |OR ">
	       	<if test="searchType=='userid'">
	       		userid like CONCAT('%',#{searchData},'%')
	       	</if>
	       	<if test="searchType=='username'">
	       		username like CONCAT('%',#{searchData},'%')
	       	</if>
			AND IsUse = 0
		</trim>
    </select>
    
    <select id="SelectDeptList" resultType="UserVO">
    	select deptname, deptcode from dept
    </select>
	<select id="SelectPositionList" resultType="UserVO">
		select positionname, positioncode from positions
	</select>    
   	<insert id="InsertUser" parameterType="UserDTO">
   		insert into user
   			(userid,username,userpasswd,usercompanycode,deptcode,positioncode,usermobile,useremail)
   		value
   			(#{userid},#{username},#{userpasswd},#{usercompanycode},#{deptcode},#{positioncode},#{usermobile},#{useremail})
   	</insert>
   	
   	<update id="UpdateUser" parameterType="UserDTO">
   		update 
			user
		set
			username = #{username}, userpasswd = #{userpasswd}, usermobile = #{usermobile}, useremail = #{useremail},
			usercompanycode = #{usercompanycode}, deptcode = #{deptcode}, positioncode = #{positioncode}
		where
			userid = #{userid}
   	</update>
   	<update id="DeleteUser" parameterType="UserDTO">
   		update 
			user
		set
			IsUse = 1
		where
			userid = #{userid}
   	</update>
   	
    <!--
        로그인된 경우 해당 세션id와 유효시간을 사용자 테이블에 세팅한다.
     -->
    <update id="keepLogin">
        update user set sessionKey = #{sessionId}, sessionLimit = #{next} where userId=#{userId}
    </update>
    <!--
        유효기간이 남아 있으면서 해당 sessionId를 가지는 사용자 정보를 꺼내오는 부분
     -->
    <select id="checkUserWithSessionKey" resultType="UserVO">
        select * from user where sessionKey = #{sessionId} and sessionLimit > now()
    </select>
    
    <update id="googleLogin" parameterType="UserDTO">
   		update 
			user
		set
			gmail = #{gmail}, gname = #{gname}, oauthcode = #{oauthcode}
		where
			username = #{gname}
   	</update>
   	
   	<select id="selectUserCowork" resultType="CoworkVO" parameterType="coworkDTO">
   		SELECT distinct
			co.coworkcode, co.coworksubject, co.coworktitle, co.coworkdate, co.userid, c.companycode, c.companyname, u.username
		FROM
			cowork co left join usercoworkcompany ucc ON co.coworkcode = ucc.coworkcode
		    left join company c ON co.coworkcompany = c.companycode
		    left join user u ON co.userid = u.userid
		WHERE
			co.userid = #{userid};
   	</select>
    
    <select id="selectManagerCowork" resultType="CoworkVO" parameterType="coworkDTO">
   		SELECT distinct
			co.coworkcode, co.coworksubject, co.coworktitle, co.coworkdate, co.userid, c.companycode, c.companyname, u.username
		FROM
			cowork co left join usercoworkcompany ucc ON co.coworkcode = ucc.coworkcode
		    left join company c ON co.coworkcompany = c.companycode
		    left join user u ON co.userid = u.userid
		WHERE
			ucc.userid = #{userid};
   	</select>
    
</mapper>
